"use client";

import { useEffect, useState, useCallback, useMemo } from "react";
import { createClient } from "@/lib/supabase/client";
import { Trade } from "@/lib/types";
import { DEMO_TRADES } from "@/lib/demo-data";
import {
  calculateTaxReport,
  getAvailableTaxYears,
  TaxSummary,
  TaxableTrade,
  CostBasisMethod,
} from "@/lib/tax-calculator";
import {
  Receipt,
  DollarSign,
  Clock,
  TrendingUp,
  TrendingDown,
  ArrowUpDown,
  Info,
  Download,
  FileText,
  FileSpreadsheet,
  ChevronDown,
  AlertTriangle,
} from "lucide-react";
import { Header } from "@/components/header";

type SortKey =
  | "symbol"
  | "exitDate"
  | "holdingPeriodDays"
  | "gainLoss"
  | "proceeds"
  | "costBasis";
type SortDir = "asc" | "desc";

function downloadBlob(content: string, filename: string, mimeType: string) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function generateForm8949CSV(trades: TaxableTrade[], year: number | null): string {
  // IRS Form 8949 columns: (a) Description, (b) Date Acquired, (c) Date Sold,
  // (d) Proceeds, (e) Cost Basis, (f) Code, (g) Adjustment Amount, (h) Gain/Loss
  // Code B = short-term NOT reported on 1099-B, E = long-term NOT reported on 1099-B
  // (Most crypto exchanges don't issue 1099-B yet)
  const header = "(a) Description of property,(b) Date acquired,(c) Date sold or disposed of,(d) Proceeds (sales price),(e) Cost or other basis,(f) Code(s),(g) Amount of adjustment,(h) Gain or (loss)";
  const rows = trades.map((t) => {
    const desc = `${t.quantity} ${t.symbol} (${t.position})`;
    const acquired = new Date(t.entryDate).toLocaleDateString("en-US");
    const sold = new Date(t.exitDate).toLocaleDateString("en-US");
    const code = t.term === "short-term" ? "B" : "E";
    return `"${desc}",${acquired},${sold},${t.proceeds.toFixed(2)},${t.costBasis.toFixed(2)},${code},0.00,${t.gainLoss.toFixed(2)}`;
  });
  const label = year ? `Tax Year ${year}` : "All Time";
  return `# IRS Form 8949 — ${label}\n# Generated by Stargate\n# Code B = Short-term (not reported on 1099-B)\n# Code E = Long-term (not reported on 1099-B)\n${header}\n${rows.join("\n")}`;
}

function generateKoinlyCSV(trades: TaxableTrade[]): string {
  // Koinly format: Date in YYYY-MM-DD HH:mm:ss UTC, period decimal separator
  const header = "Date,Sent Amount,Sent Currency,Received Amount,Received Currency,Fee Amount,Fee Currency,Net Worth Amount,Net Worth Currency,Label,Description,TxHash";
  const rows = trades.map((t) => {
    // Ensure UTC date format: YYYY-MM-DD HH:mm:ss UTC
    const d = new Date(t.exitDate);
    const date = `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, "0")}-${String(d.getUTCDate()).padStart(2, "0")} ${String(d.getUTCHours()).padStart(2, "0")}:${String(d.getUTCMinutes()).padStart(2, "0")}:${String(d.getUTCSeconds()).padStart(2, "0")} UTC`;
    if (t.position === "long") {
      return `${date},${t.quantity},${t.symbol},${t.proceeds.toFixed(2)},USD,${t.fees.toFixed(2)},USD,${t.proceeds.toFixed(2)},USD,realized gain,Closed ${t.position} position,`;
    }
    return `${date},${t.proceeds.toFixed(2)},USD,${t.quantity},${t.symbol},${t.fees.toFixed(2)},USD,${t.proceeds.toFixed(2)},USD,realized gain,Closed ${t.position} position,`;
  });
  return `${header}\n${rows.join("\n")}`;
}

function generateScheduleD(report: TaxSummary, year: number | null): string {
  const label = year ? `Tax Year ${year}` : "All Time";
  return `SCHEDULE D SUMMARY — ${label}
Generated by Stargate

SHORT-TERM CAPITAL GAINS AND LOSSES (held < 1 year)
  Total Proceeds:    $${report.totalProceeds.toFixed(2)}
  Total Cost Basis:  $${report.totalCostBasis.toFixed(2)}
  Gains:             $${report.shortTerm.gains.toFixed(2)}
  Losses:            ($${Math.abs(report.shortTerm.losses).toFixed(2)})
  Net Short-Term:    $${report.shortTerm.net.toFixed(2)}
  Number of Trades:  ${report.shortTerm.count}

LONG-TERM CAPITAL GAINS AND LOSSES (held >= 1 year)
  Gains:             $${report.longTerm.gains.toFixed(2)}
  Losses:            ($${Math.abs(report.longTerm.losses).toFixed(2)})
  Net Long-Term:     $${report.longTerm.net.toFixed(2)}
  Number of Trades:  ${report.longTerm.count}

COMBINED
  Net Gain/Loss:     $${report.netGainLoss.toFixed(2)}
  Total Fees:        $${report.totalFees.toFixed(2)}
  Total Trades:      ${report.trades.length}

NOTE: This is for informational purposes only. Consult a qualified CPA for tax filing.`;
}

export default function TaxesPage() {
  const [trades, setTrades] = useState<Trade[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedYear, setSelectedYear] = useState<number | null>(null);
  const [sortKey, setSortKey] = useState<SortKey>("exitDate");
  const [sortDir, setSortDir] = useState<SortDir>("desc");
  const [costBasis, setCostBasis] = useState<CostBasisMethod>("fifo");
  const supabase = createClient();

  const fetchTrades = useCallback(async () => {
    const { data } = await supabase
      .from("trades")
      .select("*")
      .order("open_timestamp", { ascending: false });
    const dbTrades = (data as Trade[]) ?? [];
    setTrades(dbTrades.length === 0 ? DEMO_TRADES : dbTrades);
    setLoading(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    fetchTrades();
  }, [fetchTrades]);

  // Load cost basis method from settings
  useEffect(() => {
    try {
      const stored = localStorage.getItem("stargate-global-settings");
      if (stored) {
        const settings = JSON.parse(stored);
        if (settings.costBasisMethod) setCostBasis(settings.costBasisMethod);
      }
    } catch { /* ignore */ }
  }, []);

  const years = useMemo(() => getAvailableTaxYears(trades), [trades]);

  const report: TaxSummary = useMemo(
    () => calculateTaxReport(trades, selectedYear ?? undefined, costBasis),
    [trades, selectedYear, costBasis]
  );

  const sortedTrades = useMemo(() => {
    const sorted = [...report.trades].sort((a, b) => {
      let cmp = 0;
      switch (sortKey) {
        case "symbol":
          cmp = a.symbol.localeCompare(b.symbol);
          break;
        case "exitDate":
          cmp = new Date(a.exitDate).getTime() - new Date(b.exitDate).getTime();
          break;
        case "holdingPeriodDays":
          cmp = a.holdingPeriodDays - b.holdingPeriodDays;
          break;
        case "gainLoss":
          cmp = a.gainLoss - b.gainLoss;
          break;
        case "proceeds":
          cmp = a.proceeds - b.proceeds;
          break;
        case "costBasis":
          cmp = a.costBasis - b.costBasis;
          break;
      }
      return sortDir === "asc" ? cmp : -cmp;
    });
    return sorted;
  }, [report.trades, sortKey, sortDir]);

  function toggleSort(key: SortKey) {
    if (sortKey === key) {
      setSortDir(sortDir === "asc" ? "desc" : "asc");
    } else {
      setSortKey(key);
      setSortDir("desc");
    }
  }

  function formatDate(iso: string) {
    return new Date(iso).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "2-digit",
    });
  }

  function formatDollars(n: number) {
    return `$${Math.abs(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64 text-muted text-sm">
        Loading...
      </div>
    );
  }

  return (
    <div className="space-y-6 mx-auto max-w-[1600px]">
      <Header />
      <div>
        <h2 className="text-2xl font-bold text-foreground tracking-tight flex items-center gap-2">
          <Receipt size={24} className="text-accent" />
          Tax Reports
        </h2>
        <p className="text-sm text-muted mt-0.5">
          Capital gains & losses from closed trades — Form 8949 / Schedule D format
        </p>
      </div>

      {/* Year selector + Cost Basis Method */}
      <div className="flex flex-wrap items-center gap-3">
        <div className="flex items-center gap-2">
          <button
            onClick={() => setSelectedYear(null)}
            className={`px-4 py-2 rounded-xl text-xs font-semibold transition-all ${
              selectedYear === null
                ? "bg-accent/10 text-accent border border-accent/30"
                : "bg-surface border border-border text-muted hover:text-foreground"
            }`}
          >
            All Time
          </button>
          {years.map((y) => (
            <button
              key={y}
              onClick={() => setSelectedYear(y)}
              className={`px-4 py-2 rounded-xl text-xs font-semibold transition-all ${
                selectedYear === y
                  ? "bg-accent/10 text-accent border border-accent/30"
                  : "bg-surface border border-border text-muted hover:text-foreground"
              }`}
            >
              {y}
            </button>
          ))}
        </div>

        <div className="h-6 w-px bg-border hidden sm:block" />

        {/* Cost basis method */}
        <div className="relative">
          <select
            value={costBasis}
            onChange={(e) => setCostBasis(e.target.value as CostBasisMethod)}
            className="appearance-none bg-surface border border-border rounded-xl px-3 py-2 pr-8 text-xs font-semibold text-muted hover:text-foreground cursor-pointer focus:outline-none focus:ring-2 focus:ring-accent/30 transition-all"
          >
            <option value="fifo">FIFO (First In, First Out)</option>
            <option value="lifo">LIFO (Last In, First Out)</option>
            <option value="hifo">HIFO (Highest In, First Out)</option>
          </select>
          <ChevronDown size={12} className="absolute right-2.5 top-1/2 -translate-y-1/2 text-muted pointer-events-none" />
        </div>
      </div>

      {/* Export toolbar */}
      <div className="flex flex-wrap items-center gap-2">
        <button
          onClick={() => downloadBlob(
            generateForm8949CSV(report.trades, selectedYear),
            `form-8949${selectedYear ? `-${selectedYear}` : ""}.csv`,
            "text/csv"
          )}
          className="flex items-center gap-2 px-3.5 py-2 rounded-xl bg-surface border border-border text-xs font-semibold text-muted hover:text-foreground hover:border-accent/30 transition-all"
        >
          <FileSpreadsheet size={14} className="text-accent" />
          Form 8949 CSV
        </button>
        <button
          onClick={() => downloadBlob(
            generateScheduleD(report, selectedYear),
            `schedule-d-summary${selectedYear ? `-${selectedYear}` : ""}.txt`,
            "text/plain"
          )}
          className="flex items-center gap-2 px-3.5 py-2 rounded-xl bg-surface border border-border text-xs font-semibold text-muted hover:text-foreground hover:border-accent/30 transition-all"
        >
          <FileText size={14} className="text-accent" />
          Schedule D Summary
        </button>
        <button
          onClick={() => downloadBlob(
            generateKoinlyCSV(report.trades),
            `koinly-import${selectedYear ? `-${selectedYear}` : ""}.csv`,
            "text/csv"
          )}
          className="flex items-center gap-2 px-3.5 py-2 rounded-xl bg-surface border border-border text-xs font-semibold text-muted hover:text-foreground hover:border-accent/30 transition-all"
        >
          <Download size={14} className="text-accent" />
          Koinly CSV
        </button>
      </div>

      {/* Summary cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div
          className="glass rounded-2xl border border-border/50 p-5"
          style={{ boxShadow: "var(--shadow-card)" }}
        >
          <div className="flex items-center gap-2 mb-2">
            <DollarSign size={14} className="text-muted/60" />
            <span className="text-[10px] text-muted font-semibold uppercase tracking-widest">
              Net Gain/Loss
            </span>
          </div>
          <p
            className={`text-2xl font-bold ${report.netGainLoss >= 0 ? "text-win" : "text-loss"}`}
          >
            {report.netGainLoss >= 0 ? "+" : "-"}
            {formatDollars(report.netGainLoss)}
          </p>
          <p className="text-[10px] text-muted mt-1">
            {report.trades.length} closed trades
          </p>
        </div>

        <div
          className="glass rounded-2xl border border-border/50 p-5"
          style={{ boxShadow: "var(--shadow-card)" }}
        >
          <div className="flex items-center gap-2 mb-2">
            <Clock size={14} className="text-muted/60" />
            <span className="text-[10px] text-muted font-semibold uppercase tracking-widest">
              Short-Term Net
            </span>
          </div>
          <p
            className={`text-2xl font-bold ${report.shortTerm.net >= 0 ? "text-win" : "text-loss"}`}
          >
            {report.shortTerm.net >= 0 ? "+" : "-"}
            {formatDollars(report.shortTerm.net)}
          </p>
          <p className="text-[10px] text-muted mt-1">
            {report.shortTerm.count} trades (&lt;1 year)
          </p>
        </div>

        <div
          className="glass rounded-2xl border border-border/50 p-5"
          style={{ boxShadow: "var(--shadow-card)" }}
        >
          <div className="flex items-center gap-2 mb-2">
            <TrendingUp size={14} className="text-muted/60" />
            <span className="text-[10px] text-muted font-semibold uppercase tracking-widest">
              Long-Term Net
            </span>
          </div>
          <p
            className={`text-2xl font-bold ${report.longTerm.net >= 0 ? "text-win" : "text-loss"}`}
          >
            {report.longTerm.net >= 0 ? "+" : "-"}
            {formatDollars(report.longTerm.net)}
          </p>
          <p className="text-[10px] text-muted mt-1">
            {report.longTerm.count} trades (&ge;1 year)
          </p>
        </div>

        <div
          className="glass rounded-2xl border border-border/50 p-5"
          style={{ boxShadow: "var(--shadow-card)" }}
        >
          <div className="flex items-center gap-2 mb-2">
            <TrendingDown size={14} className="text-muted/60" />
            <span className="text-[10px] text-muted font-semibold uppercase tracking-widest">
              Total Fees
            </span>
          </div>
          <p className="text-2xl font-bold text-loss">
            -{formatDollars(report.totalFees)}
          </p>
          <p className="text-[10px] text-muted mt-1">Deductible expenses</p>
        </div>
      </div>

      {/* Short-term vs Long-term breakdown */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {(["shortTerm", "longTerm"] as const).map((term) => {
          const data = report[term];
          const label = term === "shortTerm" ? "Short-Term" : "Long-Term";
          const desc = term === "shortTerm" ? "Held < 365 days" : "Held >= 365 days";
          return (
            <div
              key={term}
              className="glass rounded-2xl border border-border/50 p-5"
              style={{ boxShadow: "var(--shadow-card)" }}
            >
              <h3 className="text-sm font-semibold text-foreground mb-1">
                {label} Capital Gains
              </h3>
              <p className="text-[10px] text-muted mb-4">{desc}</p>
              <div className="space-y-2">
                <div className="flex items-center justify-between px-3 py-2 rounded-lg bg-background">
                  <span className="text-xs text-muted">Gains</span>
                  <span className="text-xs font-bold text-win">
                    +{formatDollars(data.gains)}
                  </span>
                </div>
                <div className="flex items-center justify-between px-3 py-2 rounded-lg bg-background">
                  <span className="text-xs text-muted">Losses</span>
                  <span className="text-xs font-bold text-loss">
                    {formatDollars(data.losses)}
                  </span>
                </div>
                <div className="flex items-center justify-between px-3 py-2 rounded-lg bg-accent/5 border border-accent/10">
                  <span className="text-xs font-medium text-foreground">
                    Net
                  </span>
                  <span
                    className={`text-xs font-bold ${data.net >= 0 ? "text-win" : "text-loss"}`}
                  >
                    {data.net >= 0 ? "+" : "-"}
                    {formatDollars(data.net)}
                  </span>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Enhanced IRS info section */}
      <div className="glass rounded-2xl border border-border/50 p-5 space-y-4" style={{ boxShadow: "var(--shadow-card)" }}>
        <div className="flex items-center gap-2 mb-1">
          <Info size={16} className="text-accent shrink-0" />
          <h3 className="text-sm font-semibold text-foreground">Tax Reporting Guide</h3>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="space-y-3">
            <div>
              <p className="text-xs font-semibold text-foreground mb-1">IRS Form 8949 / Schedule D</p>
              <p className="text-[11px] text-muted leading-relaxed">
                Report each crypto disposal on Form 8949 with date acquired, date sold, proceeds, cost basis, and gain/loss. Short-term gains (&lt;1 year) are taxed as ordinary income. Long-term gains have preferential rates (0%, 15%, or 20%).
              </p>
            </div>
            <div>
              <p className="text-xs font-semibold text-foreground mb-1">Per-Account Cost Basis (2025+)</p>
              <p className="text-[11px] text-muted leading-relaxed">
                As of January 2025, the IRS requires cost basis tracking per account/wallet. Universal pooling across exchanges is no longer permitted. Choose your method (FIFO, LIFO, or HIFO) per account.
              </p>
            </div>
            <div>
              <p className="text-xs font-semibold text-foreground mb-1">Staking & DeFi Income</p>
              <p className="text-[11px] text-muted leading-relaxed">
                Staking rewards are taxed as ordinary income at fair market value when received. DeFi yield, airdrops, and mining rewards follow the same rule. These are separate from capital gains.
              </p>
            </div>
          </div>

          <div className="space-y-3">
            <div>
              <p className="text-xs font-semibold text-foreground mb-1">
                <span className="text-win">Tax Loss Harvesting</span> — Your Advantage
              </p>
              <p className="text-[11px] text-muted leading-relaxed">
                Crypto is currently <strong className="text-win">exempt from wash sale rules</strong>. You can sell at a loss and immediately rebuy — powerful for reducing your tax bill.
              </p>
            </div>
            <div className="flex items-start gap-2 px-3 py-2 rounded-lg bg-amber-500/5 border border-amber-500/10">
              <AlertTriangle size={12} className="text-amber-500 mt-0.5 shrink-0" />
              <p className="text-[10px] text-amber-400/80 leading-relaxed">
                <strong>Wash sale legislation pending:</strong> Bills to extend wash sale rules to crypto are in committee. Build your tax loss harvesting strategy now while the exemption exists.
              </p>
            </div>
            <div>
              <p className="text-xs font-semibold text-foreground mb-1">New for 2025-2026</p>
              <p className="text-[11px] text-muted leading-relaxed">
                <strong>Form 1099-DA</strong> (2025): Brokers begin reporting gross proceeds. <strong>Cost basis reporting</strong> (2026+): Required for assets acquired after Jan 1, 2026. <strong>Crypto-to-crypto swaps</strong> are taxable events.
              </p>
            </div>
            <div>
              <p className="text-xs font-semibold text-foreground mb-1">Cost Basis Methods</p>
              <p className="text-[11px] text-muted leading-relaxed">
                <strong>FIFO</strong>: Sells oldest lots first (default, IRS safe harbor). <strong>LIFO</strong>: Sells newest lots first (can defer gains). <strong>HIFO</strong>: Sells highest-cost lots first (minimizes current tax).
              </p>
            </div>
            <div>
              <p className="text-xs font-semibold text-foreground mb-1">$3,000 Loss Deduction</p>
              <p className="text-[11px] text-muted leading-relaxed">
                If your net capital losses exceed gains, you can deduct up to $3,000/year against ordinary income. Excess losses carry forward indefinitely to future tax years.
              </p>
            </div>
          </div>
        </div>

        <div className="flex items-start gap-2 px-3 py-2.5 rounded-lg bg-amber-500/5 border border-amber-500/10">
          <AlertTriangle size={14} className="text-amber-500 mt-0.5 shrink-0" />
          <p className="text-[11px] text-muted leading-relaxed">
            <strong className="text-amber-500">Disclaimer:</strong> This is for informational purposes only and does not constitute tax advice. Crypto tax rules are complex and change frequently. Always consult a qualified CPA or tax professional for your specific situation.
          </p>
        </div>
      </div>

      {/* Trade-by-trade table */}
      <div
        className="glass rounded-2xl border border-border/50 overflow-hidden"
        style={{ boxShadow: "var(--shadow-card)" }}
      >
        <div className="px-5 py-4 border-b border-border/30">
          <h3 className="text-sm font-semibold text-foreground">
            Trade-by-Trade Breakdown
          </h3>
          <p className="text-[10px] text-muted mt-0.5">
            {sortedTrades.length} taxable events • Cost basis: {costBasis.toUpperCase()}
          </p>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-xs">
            <thead>
              <tr className="border-b border-border/30">
                {[
                  { key: "symbol" as SortKey, label: "Symbol" },
                  { key: "exitDate" as SortKey, label: "Date Sold" },
                  { key: "holdingPeriodDays" as SortKey, label: "Held" },
                  { key: "proceeds" as SortKey, label: "Proceeds" },
                  { key: "costBasis" as SortKey, label: "Cost Basis" },
                  { key: "gainLoss" as SortKey, label: "Gain/Loss" },
                ].map((col) => (
                  <th
                    key={col.key}
                    onClick={() => toggleSort(col.key)}
                    className="px-4 py-3 text-left text-[10px] text-muted font-semibold uppercase tracking-wider cursor-pointer hover:text-foreground transition-colors"
                  >
                    <span className="flex items-center gap-1">
                      {col.label}
                      <ArrowUpDown
                        size={10}
                        className={
                          sortKey === col.key ? "text-accent" : "opacity-30"
                        }
                      />
                    </span>
                  </th>
                ))}
                <th className="px-4 py-3 text-left text-[10px] text-muted font-semibold uppercase tracking-wider">
                  Term
                </th>
              </tr>
            </thead>
            <tbody>
              {sortedTrades.map((t) => (
                <tr
                  key={t.id}
                  className="border-b border-border/10 hover:bg-surface-hover/50 transition-colors"
                >
                  <td className="px-4 py-3 font-medium text-foreground">
                    <span className="flex items-center gap-1.5">
                      {t.symbol}
                      <span
                        className={`text-[9px] px-1 py-0.5 rounded ${
                          t.position === "long"
                            ? "bg-win/10 text-win"
                            : "bg-loss/10 text-loss"
                        }`}
                      >
                        {t.position.toUpperCase()}
                      </span>
                    </span>
                  </td>
                  <td className="px-4 py-3 text-muted">
                    {formatDate(t.exitDate)}
                  </td>
                  <td className="px-4 py-3 text-muted">
                    {t.holdingPeriodDays}d
                  </td>
                  <td className="px-4 py-3 text-foreground">
                    {formatDollars(t.proceeds)}
                  </td>
                  <td className="px-4 py-3 text-foreground">
                    {formatDollars(t.costBasis)}
                  </td>
                  <td
                    className={`px-4 py-3 font-bold ${t.gainLoss >= 0 ? "text-win" : "text-loss"}`}
                  >
                    {t.gainLoss >= 0 ? "+" : "-"}
                    {formatDollars(t.gainLoss)}
                  </td>
                  <td className="px-4 py-3">
                    <span
                      className={`text-[9px] px-2 py-0.5 rounded-full font-semibold ${
                        t.term === "short-term"
                          ? "bg-amber-500/10 text-amber-500"
                          : "bg-accent/10 text-accent"
                      }`}
                    >
                      {t.term === "short-term" ? "ST" : "LT"}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {sortedTrades.length === 0 && (
          <div className="py-12 text-center text-sm text-muted">
            No closed trades{selectedYear ? ` in ${selectedYear}` : ""} to
            report.
          </div>
        )}
      </div>
    </div>
  );
}
